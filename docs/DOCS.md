# åšå®¢ç³»ç»Ÿå®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
3. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
4. [COS å­˜å‚¨é…ç½®](#cos-å­˜å‚¨é…ç½®)
5. [åœ°å›¾æœåŠ¡é…ç½®](#åœ°å›¾æœåŠ¡é…ç½®)
6. [åˆ†ç‰‡ä¸Šä¼ ](#åˆ†ç‰‡ä¸Šä¼ )
7. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Node.js 18+ 
- PostgreSQL 14+
- npm/pnpm/yarn

### å®‰è£…æ­¥éª¤

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆè§ä¸‹èŠ‚ï¼‰
cp .env.example .env

# 3. åˆå§‹åŒ–æ•°æ®åº“
npx prisma migrate dev

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

è®¿é—® http://localhost:3000

---

## ç¯å¢ƒé…ç½®

åˆ›å»º `.env` æ–‡ä»¶å¹¶é…ç½®ï¼š

```env
# æ•°æ®åº“
DATABASE_URL="postgresql://postgres:å¯†ç @localhost:5432/blog"

# è®¤è¯
NEXTAUTH_SECRET="è¿è¡Œ: openssl rand -base64 32"
NEXTAUTH_URL="http://localhost:3000"

# è…¾è®¯äº‘ COSï¼ˆå›¾ç‰‡/è§†é¢‘å­˜å‚¨ï¼‰
COS_REGION="ap-shanghai"
COS_SECRET_ID="ä½ çš„SecretId"
COS_SECRET_KEY="ä½ çš„SecretKey"
COS_BUCKET="ä½ çš„Bucketåç§°"
COS_CUSTOM_DOMAIN="å¯é€‰ï¼šä½ çš„è‡ªå®šä¹‰åŸŸåæˆ–é»˜è®¤åŸŸå"

# é«˜å¾·åœ°å›¾ï¼ˆå¯é€‰ï¼Œç”¨äºåœ°ç†ä½ç½®è½¬æ¢ï¼‰
NEXT_PUBLIC_AMAP_KEY="ä½ çš„é«˜å¾·API_Key"
```

---

## æ•°æ®åº“é…ç½®

### PostgreSQL æƒé™é—®é¢˜

å¦‚é‡åˆ° `permission denied to create database` é”™è¯¯ï¼š

**æ–¹æ¡ˆ 1ï¼šä½¿ç”¨è¶…çº§ç”¨æˆ·ï¼ˆæ¨èï¼‰**

```env
DATABASE_URL="postgresql://postgres:ä½ çš„å¯†ç @localhost:5432/blog"
```

**æ–¹æ¡ˆ 2ï¼šæˆäºˆç”¨æˆ·æƒé™**

```bash
# è¿æ¥ PostgreSQL
psql -U postgres

# æˆæƒ
ALTER USER "ä½ çš„ç”¨æˆ·å" CREATEDB;
```

### æ•°æ®åº“è¿ç§»

```bash
# å¼€å‘ç¯å¢ƒ
npx prisma migrate dev

# ç”Ÿäº§ç¯å¢ƒ
npx prisma migrate deploy

# é‡æ–°ç”Ÿæˆ Prisma Client
npx prisma generate

# å¯è§†åŒ–ç®¡ç†æ•°æ®
npx prisma studio
```

---

## COS å­˜å‚¨é…ç½®

### è·å– COS é…ç½®

1. **åˆ›å»º Bucket**
   - è®¿é—® [è…¾è®¯äº‘ COS æ§åˆ¶å°](https://console.cloud.tencent.com/cos)
   - åˆ›å»ºå­˜å‚¨æ¡¶ï¼ˆBucketï¼‰ï¼Œé€‰æ‹©åŒºåŸŸï¼ˆå¦‚ `ap-shanghai`ï¼‰ï¼Œæƒé™å»ºè®®ã€Œå…¬æœ‰è¯»ã€

2. **è·å–å¯†é’¥**
   - è®¿é—® [è®¿é—®ç®¡ç† - CAM](https://console.cloud.tencent.com/cam/capi)
   - åˆ›å»ºæˆ–æŸ¥çœ‹ `SecretId`/`SecretKey`

3. **é»˜è®¤è®¿é—®åŸŸå**
   - `${Bucket}.cos.${Region}.myqcloud.com`
   - ä¾‹å¦‚ï¼š`csgblod-1384771334.cos.ap-shanghai.myqcloud.com`

### åŠŸèƒ½ç‰¹æ€§

âœ… å•å›¾/æ‰¹é‡ä¸Šä¼   
âœ… æ”¯æŒ JPGã€PNGã€GIFã€WebPã€HEIC  
âœ… æ”¯æŒè§†é¢‘ï¼ˆMP4ã€MOVã€AVIã€WebMï¼‰  
âœ… å›¾ç‰‡æœ€å¤§ 10MBï¼Œè§†é¢‘æœ€å¤§ 100MB  
âœ… è‡ªåŠ¨ HEIC è½¬ JPEG  
âœ… æå–ç…§ç‰‡ EXIF ä¿¡æ¯ï¼ˆæ‹æ‘„æ—¶é—´ã€ä½ç½®ã€ç›¸æœºå‹å·ï¼‰  
âœ… åˆ†ç‰‡å¹¶å‘ä¸Šä¼ å¤§æ–‡ä»¶ï¼ˆç±»ä¼¼è¿…é›·ï¼‰

---

## åœ°å›¾æœåŠ¡é…ç½®

ç”¨äºå°†ç…§ç‰‡ GPS åæ ‡è½¬æ¢ä¸ºä¸­æ–‡åœ°å€ã€‚

### ç”³è¯·é«˜å¾·åœ°å›¾ API Key

1. è®¿é—® https://lbs.amap.com/ æ³¨å†Œ
2. è¿›å…¥æ§åˆ¶å° https://console.amap.com/dev/key/app
3. åˆ›å»ºåº”ç”¨ï¼Œæ·»åŠ  Keyï¼ˆé€‰æ‹©ã€ŒWebæœåŠ¡ã€ï¼‰
4. å°† Key æ·»åŠ åˆ° `.env`ï¼š

```env
NEXT_PUBLIC_AMAP_KEY="ä½ çš„API_Key"
```

### å®‰å…¨å»ºè®®

- å¼€å‘ç¯å¢ƒï¼šå¯ç›´æ¥ä½¿ç”¨ `NEXT_PUBLIC_` å‰ç¼€
- ç”Ÿäº§ç¯å¢ƒï¼šå»ºè®®åœ¨é«˜å¾·æ§åˆ¶å°è®¾ç½® IP ç™½åå•

### å…è´¹é¢åº¦

ä¸ªäººå¼€å‘è€…è®¤è¯åæ¯æ—¥ 30 ä¸‡æ¬¡ï¼Œä¸ªäººåšå®¢å®Œå…¨å¤Ÿç”¨ã€‚

---

## åˆ†ç‰‡ä¸Šä¼ 

### å·¥ä½œåŸç†

å¤§æ–‡ä»¶ï¼ˆâ‰¥10MBï¼‰è‡ªåŠ¨åˆ‡åˆ†æˆ 5MB å°ç‰‡æ®µï¼Œ3 ä¸ªå¹¶å‘ä¸Šä¼ ã€‚

```
æ–‡ä»¶ â†’ åˆ†ç‰‡1ã€2ã€3... â†’ å¹¶å‘ä¸Šä¼  â†’ COS åˆå¹¶ â†’ å®Œæˆ
```

### æ€§èƒ½æå‡

| æ–‡ä»¶å¤§å° | ä¼ ç»Ÿä¸Šä¼  | åˆ†ç‰‡ä¸Šä¼  | æå‡ |
|---------|---------|---------|-----|
| 50MB    | ~120ç§’  | ~45ç§’   | 62%â†‘ |
| 100MB   | ~240ç§’  | ~85ç§’   | 65%â†‘ |
| 500MB   | ~1200ç§’ | ~400ç§’  | 67%â†‘ |

### å‚æ•°è°ƒæ•´

åœ¨ç›¸å†Œä¸Šä¼ ä»£ç ä¸­ä¿®æ”¹ï¼š

```typescript
await uploadFileInChunks({
  chunkSize: 5 * 1024 * 1024,  // åˆ†ç‰‡å¤§å°ï¼ˆ3-10MBï¼‰
  concurrent: 3,                // å¹¶å‘æ•°ï¼ˆ2-8ï¼‰
  // ...
});
```

**å»ºè®®é…ç½®**ï¼š
- ç½‘é€Ÿæ…¢ï¼š`chunkSize: 3MB, concurrent: 2`
- ç½‘é€Ÿä¸­ç­‰ï¼š`chunkSize: 5MB, concurrent: 3` â­ é»˜è®¤
- ç½‘é€Ÿå¿«ï¼š`chunkSize: 10MB, concurrent: 5`

---

## éƒ¨ç½²æŒ‡å—

### Vercel éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. æ¨é€ä»£ç åˆ° GitHub
2. åœ¨ [Vercel](https://vercel.com) å¯¼å…¥é¡¹ç›®
3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆDATABASE_URL, COS é…ç½®ç­‰ï¼‰
4. éƒ¨ç½²

### Docker éƒ¨ç½²

```bash
# æ„å»º
docker build -t blog .

# è¿è¡Œ
docker run -p 3000:3000 \
  -e DATABASE_URL="..." \
  -e COS_SECRET_ID="..." \
  blog
```

### ä¼ ç»ŸæœåŠ¡å™¨

```bash
# æ„å»º
npm run build

# å¯åŠ¨
npm start
```

---

## å¸¸è§é—®é¢˜

### Q: å›¾ç‰‡æ— æ³•æ˜¾ç¤º

**A:** æ£€æŸ¥ï¼š
- COS Bucket æ˜¯å¦è®¾ç½®ä¸ºã€Œå…¬å…±è¯»ã€
- `.env` ä¸­ COS é…ç½®æ˜¯å¦æ­£ç¡®
- é‡å¯å¼€å‘æœåŠ¡å™¨

### Q: æ•°æ®åº“è¿æ¥å¤±è´¥

**A:** 
- ç¡®è®¤ PostgreSQL æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ `DATABASE_URL` æ ¼å¼å’Œå¯†ç 
- å°è¯•ä½¿ç”¨ `postgres` è¶…çº§ç”¨æˆ·

### Q: HEIC å›¾ç‰‡æ— æ³•ä¸Šä¼ 

**A:** 
- ç³»ç»Ÿä¼šè‡ªåŠ¨å°† HEIC è½¬ä¸º JPEG
- å¦‚é‡é—®é¢˜ï¼Œæ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

### Q: è§†é¢‘ä¸Šä¼ å¤ªæ…¢

**A:** 
- å·²å¯ç”¨åˆ†ç‰‡å¹¶å‘ä¸Šä¼ 
- å¯è°ƒæ•´ `concurrent` å‚æ•°ï¼ˆ3-5ï¼‰
- æ£€æŸ¥ç½‘ç»œé€Ÿåº¦

### Q: GPS ä½ç½®æ˜¾ç¤ºç»çº¬åº¦è€Œéåœ°å

**A:** 
- é…ç½®é«˜å¾·åœ°å›¾ API Key
- é‡å¯å¼€å‘æœåŠ¡å™¨
- æ£€æŸ¥ API é…é¢æ˜¯å¦ç”¨å®Œ

### Q: ä¸Šä¼ å¤±è´¥

**A:** 
1. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå›¾ç‰‡â‰¤10MBï¼Œè§†é¢‘â‰¤100MBï¼‰
2. æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
3. æ£€æŸ¥ OSS AccessKey æƒé™
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰é”™è¯¯ä¿¡æ¯

---

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 14 + React 18 + TypeScript
- **æ•°æ®åº“**: PostgreSQL + Prisma ORM
- **è®¤è¯**: NextAuth.js
- **å­˜å‚¨**: è…¾è®¯äº‘ COS
- **æ ·å¼**: Tailwind CSS
- **Markdown**: react-simplemde-editor + react-markdown
- **å›¾ç‰‡å¤„ç†**: heic2any + exifr
- **åœ°å›¾**: é«˜å¾·åœ°å›¾ API

---

## æ ¸å¿ƒæ–‡ä»¶

### å·¥å…·å‡½æ•°
- `lib/oss.ts` - å¯¹è±¡å­˜å‚¨ä¸Šä¼ ï¼ˆCOSï¼‰
- `lib/upload-chunked.ts` - åˆ†ç‰‡ä¸Šä¼ 
- `lib/image-utils.ts` - å›¾ç‰‡å¤„ç†ï¼ˆHEICã€EXIFï¼‰
- `lib/auth.ts` - ç”¨æˆ·è®¤è¯

### API è·¯ç”±
- `app/api/admin/upload/` - æ–‡ä»¶ä¸Šä¼ 
- `app/api/admin/posts/` - æ–‡ç« ç®¡ç†
- `app/api/admin/albums/` - ç›¸å†Œç®¡ç†
- `app/api/geocode/` - åœ°ç†ç¼–ç 

### ç®¡ç†é¡µé¢
- `app/admin/posts/` - æ–‡ç« ç®¡ç†
- `app/admin/gallery/` - å›¾åº“ç®¡ç†
- `app/admin/moments/` - éšè®°ç®¡ç†

---

## æ€§èƒ½ä¼˜åŒ–

1. **å›¾ç‰‡ä¼˜åŒ–**: ä½¿ç”¨ Next.js Image ç»„ä»¶
2. **åˆ†ç‰‡ä¸Šä¼ **: å¤§æ–‡ä»¶å¹¶å‘ä¸Šä¼ 
3. **ç¼“å­˜ç­–ç•¥**: é™æ€é¡µé¢ ISR
4. **CDN**: COS + CDN åŠ é€Ÿ
5. **æ•°æ®åº“**: æ·»åŠ å¸¸ç”¨å­—æ®µç´¢å¼•

---

## å®‰å…¨å»ºè®®

1. âš ï¸ ä¸è¦å°† `.env` æäº¤åˆ° Git
2. å®šæœŸæ›´æ¢ AccessKey å’Œå¯†ç 
3. ç”Ÿäº§ç¯å¢ƒå¯ç”¨ HTTPS
4. é…ç½® COS é˜²ç›—é“¾
5. è®¾ç½®é«˜å¾· API IP ç™½åå•

---

## å¤‡ä»½ç­–ç•¥

### æ•°æ®åº“å¤‡ä»½

```bash
# å¯¼å‡º
pg_dump -U postgres blog > backup.sql

# æ¢å¤
psql -U postgres blog < backup.sql
```

### COS æ–‡ä»¶å¤‡ä»½

å®šæœŸå¤‡ä»½ COS Bucket æˆ–é…ç½®è·¨åœ°åŸŸå¤åˆ¶ã€‚

---

éœ€è¦æ›´å¤šå¸®åŠ©ï¼ŸæŸ¥çœ‹é¡¹ç›® README æˆ–æäº¤ Issueã€‚

